<?php
/**
 * @file
 * Custom field formatters for Thirdwing site
 * 
 * Provides custom CCK field formatters that were previously defined
 * through the custom_formatters module.
 */

/**
 * Implementation of hook_field_formatter_info().
 * 
 * Register custom formatters with CCK.
 */
function thirdwing_formatters_field_formatter_info() {
  return array(
    'repertoire_met_jaar' => array(
      'label' => t('Repertoire met jaar'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer_link' => array(
      'label' => t('Badge nummer (met link)'),
      'field types' => array('number_integer'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer' => array(
      'label' => t('Badge nummer (zonder link)'),
      'field types' => array('number_integer'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer_nodereference' => array(
      'label' => t('Badge nummer (node reference)'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_koorfunctie' => array(
      'label' => t('Badge koorfunctie'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
  );
}

/**
 * Implementation of hook_theme().
 * 
 * Register theme functions for formatters.
 */
function thirdwing_formatters_theme() {
  return array(
    'thirdwing_formatters_formatter_repertoire_met_jaar' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer_link' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer_nodereference' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_koorfunctie' => array(
      'arguments' => array('element' => NULL),
    ),
  );
}

/**
 * Format a repertoire field with corresponding year field appended in parentheses.
 * 
 * Automatically detects the correct year field based on the current field name:
 * - field_rep_arr -> field_rep_arr_jaar
 * - field_rep_componist -> field_rep_componist_jaar
 * - field_rep_uitv -> field_rep_uitv_jaar
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_repertoire_met_jaar($element) {
  $output = $element['#item']['safe'];
  
  // Map field names to their corresponding year fields
  $year_field_map = array(
    'field_rep_arr' => 'field_rep_arr_jaar',
    'field_rep_componist' => 'field_rep_componist_jaar',
    'field_rep_uitv' => 'field_rep_uitv_jaar',
  );
  
  // Get the current field name
  $field_name = $element['#field_name'];
  
  // Check if we have a year field mapping for this field
  if (isset($year_field_map[$field_name])) {
    $year_field = $year_field_map[$field_name];
    
    // Append the year if it exists
    if (isset($element['#node']->{$year_field}[0]['value']) && !empty($element['#node']->{$year_field}[0]['value'])) {
      $output .= ' (' . check_plain($element['#node']->{$year_field}[0]['value']) . ')';
    }
  }
  
  return $output;
}

/**
 * Format an integer field as a badge with link to the node.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer_link($element) {
  $value = $element['#item']['value'];
  
  // Get the node path
  if (isset($element['#node']->nid)) {
    $node_path = 'node/' . $element['#node']->nid;
    
    return l('<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>', $node_path, array('html' => TRUE));
  }
  
  // Fallback if no node context
  return '<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>';
}

/**
 * Format an integer field as a badge without link.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer($element) {
  $value = $element['#item']['value'];
  
  return '<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>';
}

/**
 * Format a node reference field as badge nummer with seizoen.
 * 
 * Displays the field_audio_nummer and field_audio_seizoen from the referenced node.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer_nodereference($element) {
  if (!empty($element['#item']['nid'])) {
    $referenced_node = node_load($element['#item']['nid']);
    
    if ($referenced_node && isset($referenced_node->field_audio_nummer[0]['value']) && isset($referenced_node->field_audio_seizoen[0]['value'])) {
      $audio_nummer = $referenced_node->field_audio_nummer[0]['value'];
      $audio_type = check_plain($referenced_node->field_audio_seizoen[0]['value']);
      $node_url = url('node/' . $referenced_node->nid);
      
      return '<a href="' . $node_url . '"><div class="badge badge-nummer">' . check_plain($audio_nummer) . '</div></a><div class="badge badge-color-grey-light">' . $audio_type . '</div>';
    }
  }
  
  return '';
}

/**
 * Format a text field as a choir function badge.
 * 
 * Converts function codes to full names and displays them as badges.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_koorfunctie($element) {
  $value = $element['#item']['value'];
  $key = '';
  
  // Map function codes to labels
  if ($value == 'A') { 
    $key = 'Tenor'; 
  }
  elseif ($value == 'B') { 
    $key = 'Bas'; 
  }
  elseif ($value == 'C') { 
    $key = '1e Sopraan'; 
  }
  elseif ($value == 'D') { 
    $key = '2e Sopraan'; 
  }
  elseif ($value == 'E') { 
    $key = 'Alt'; 
  }
  elseif ($value == 'Y1') { 
    $key = 'Dirigent'; 
  }
  elseif ($value == 'Z1') { 
    $key = 'Toetsenist'; 
  }
  elseif ($value == 'Z2') { 
    $key = 'Gitarist'; 
  }
  elseif ($value == 'Z3') { 
    $key = 'Bassist'; 
  }
  elseif ($value == 'Z4') { 
    $key = 'Drummer'; 
  }
  elseif ($value == 'Z5') { 
    $key = 'Percussionist'; 
  }
  
  if ($key) {
    return '<span class="badge badge-functie badge-functie-' . check_plain($value) . '" title="' . check_plain($key) . '">' . check_plain($key) . '</span>';
  }
  
  return '';
}

/**
 * Implementation of hook_content_is_empty().
 * 
 * CCK uses this to determine if a field value is empty.
 */
function thirdwing_formatters_content_is_empty($item, $field) {
  if (empty($item['value'])) {
    return TRUE;
  }
  return FALSE;
}

<?php
/**
 * @file
 * Custom field formatters for Thirdwing site
 * 
 * Provides custom CCK field formatters that were previously defined
 * through the custom_formatters module.
 */

/**
 * Implementation of hook_field_formatter_info().
 * 
 * Register custom formatters with CCK.
 */
function thirdwing_formatters_field_formatter_info() {
  return array(
    'repertoire_met_jaar' => array(
      'label' => t('Repertoire met jaar'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer_link' => array(
      'label' => t('Badge nummer (met link)'),
      'field types' => array('number_integer'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer' => array(
      'label' => t('Badge nummer (zonder link)'),
      'field types' => array('number_integer'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer_nodereference' => array(
      'label' => t('Badge nummer (node reference)'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_koorfunctie' => array(
      'label' => t('Badge koorfunctie'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_location' => array(
      'label' => t('Badge location'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_location_extended' => array(
      'label' => t('Badge location (uitgebreid)'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
  );
}

/**
 * Implementation of hook_theme().
 * 
 * Register theme functions for formatters.
 */
function thirdwing_formatters_theme() {
  return array(
    'thirdwing_formatters_formatter_repertoire_met_jaar' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer_link' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer_nodereference' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_koorfunctie' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_location' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_location_extended' => array(
      'arguments' => array('element' => NULL),
    ),
  );
}

/**
 * Format a repertoire field with corresponding year field appended in parentheses.
 * 
 * Automatically detects the correct year field based on the current field name:
 * - field_rep_arr -> field_rep_arr_jaar
 * - field_rep_componist -> field_rep_componist_jaar
 * - field_rep_uitv -> field_rep_uitv_jaar
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_repertoire_met_jaar($element) {
  $output = $element['#item']['safe'];
  
  // Map field names to their corresponding year fields
  $year_field_map = array(
    'field_rep_arr' => 'field_rep_arr_jaar',
    'field_rep_componist' => 'field_rep_componist_jaar',
    'field_rep_uitv' => 'field_rep_uitv_jaar',
  );
  
  // Get the current field name
  $field_name = $element['#field_name'];
  
  // Check if we have a year field mapping for this field
  if (isset($year_field_map[$field_name])) {
    $year_field = $year_field_map[$field_name];
    
    // Append the year if it exists
    if (isset($element['#node']->{$year_field}[0]['value']) && !empty($element['#node']->{$year_field}[0]['value'])) {
      $output .= ' (' . check_plain($element['#node']->{$year_field}[0]['value']) . ')';
    }
  }
  
  return $output;
}

/**
 * Format an integer field as a badge with link to the node.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer_link($element) {
  $value = $element['#item']['value'];
  
  // Get the node path
  if (isset($element['#node']->nid)) {
    $node_path = 'node/' . $element['#node']->nid;
    
    return l('<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>', $node_path, array('html' => TRUE));
  }
  
  // Fallback if no node context
  return '<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>';
}

/**
 * Format an integer field as a badge without link.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer($element) {
  $value = $element['#item']['value'];
  
  return '<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>';
}

/**
 * Format a node reference field as badge nummer with seizoen.
 * 
 * Displays the field_audio_nummer and field_audio_seizoen from the referenced node.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer_nodereference($element) {
  if (!empty($element['#item']['nid'])) {
    $referenced_node = node_load($element['#item']['nid']);
    
    if ($referenced_node && isset($referenced_node->field_audio_nummer[0]['value']) && isset($referenced_node->field_audio_seizoen[0]['value'])) {
      $audio_nummer = $referenced_node->field_audio_nummer[0]['value'];
      $audio_type = check_plain($referenced_node->field_audio_seizoen[0]['value']);
      $node_url = url('node/' . $referenced_node->nid);
      
      return '<a href="' . $node_url . '"><div class="badge badge-nummer">' . check_plain($audio_nummer) . '</div></a><div class="badge badge-color-grey-light">' . $audio_type . '</div>';
    }
  }
  
  return '';
}

/**
 * Format a text field as a choir function badge.
 * 
 * Converts function codes to full names and displays them as badges.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_koorfunctie($element) {
  $value = $element['#item']['value'];
  $key = '';
  
  // Map function codes to labels
  if ($value == 'A') { 
    $key = 'Tenor'; 
  }
  elseif ($value == 'B') { 
    $key = 'Bas'; 
  }
  elseif ($value == 'C') { 
    $key = '1e Sopraan'; 
  }
  elseif ($value == 'D') { 
    $key = '2e Sopraan'; 
  }
  elseif ($value == 'E') { 
    $key = 'Alt'; 
  }
  elseif ($value == 'Y1') { 
    $key = 'Dirigent'; 
  }
  elseif ($value == 'Z1') { 
    $key = 'Toetsenist'; 
  }
  elseif ($value == 'Z2') { 
    $key = 'Gitarist'; 
  }
  elseif ($value == 'Z3') { 
    $key = 'Bassist'; 
  }
  elseif ($value == 'Z4') { 
    $key = 'Drummer'; 
  }
  elseif ($value == 'Z5') { 
    $key = 'Percussionist'; 
  }
  
  if ($key) {
    return '<span class="badge badge-functie badge-functie-' . check_plain($value) . '" title="' . check_plain($key) . '">' . check_plain($key) . '</span>';
  }
  
  return '';
}

/**
 * Format a node reference as a location badge (basic).
 * 
 * Displays location title and plaats from the referenced node.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_location($element) {
  $nid = $element['#item']['nid'];
  
  if ($nid && $node = node_load($nid)) {
    $title = check_plain($node->title);
    $field_value = '';
    
    if (isset($node->field_l_plaats) && !empty($node->field_l_plaats[0]['value'])) {
      $field_value = check_plain($node->field_l_plaats[0]['value']);
    }
    
    return '<span class="badge badge-location fa fa-map-marker"><span class="badge-location-title">' . $title . '</span> <span class="badge-location-plaats">' . $field_value . '</span></span>';
  }
  
  return '';
}

/**
 * Format a node reference as a location badge (extended).
 * 
 * Displays full location details including address, postcode, plaats, route links, and notes.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_location_extended($element) {
  $nid = $element['#item']['nid'];
  
  if ($nid && $node = node_load($nid)) {
    $title = check_plain($node->title);
    $output = '<span class="badge badge-location badge-location-ext fa fa-map-marker"><span class="badge-location-title">' . $title . '</span>';
    
    // Get field_l_adres
    if (isset($node->field_l_adres) && !empty($node->field_l_adres[0]['value'])) {
      $adres = check_plain($node->field_l_adres[0]['value']);
      $output .= '<span class="badge-location-adres">' . $adres . '</span>';
    }
    
    // Get field_l_postcode and field_l_plaats
    $postcode = '';
    if (isset($node->field_l_postcode) && !empty($node->field_l_postcode[0]['value'])) {
      $postcode = check_plain($node->field_l_postcode[0]['value']);
    }
    
    if (isset($node->field_l_plaats) && !empty($node->field_l_plaats[0]['value'])) {
      $plaats = check_plain($node->field_l_plaats[0]['value']);
      $output .= '<span class="badge-location-plaats">' . $postcode . ' ' . $plaats . '</span>';
    }
    
    // Get field_l_routelink (link field with multiple values)
    $routelinks = array();
    if (isset($node->field_l_routelink) && is_array($node->field_l_routelink)) {
      foreach ($node->field_l_routelink as $link_item) {
        if (!empty($link_item['url'])) {
          $link_url = check_url($link_item['url']);
          $link_title = !empty($link_item['title']) ? check_plain($link_item['title']) : $link_url;
          $routelinks[] = '<a href="' . $link_url . '">' . $link_title . '</a>';
        }
      }
      if (!empty($routelinks)) {
        $output .= '<span class="badge-location-link">' . implode(' | ', $routelinks) . '</span>';
      }
    }
    
    // Get field_l_bijzonderheden from the current node (not the referenced node)
    $current_node = $element['#node'];
    if (isset($current_node->field_l_bijzonderheden) && !empty($current_node->field_l_bijzonderheden[0]['value'])) {
      $bijzonderheden = check_plain($current_node->field_l_bijzonderheden[0]['value']);
      $output .= '<span class="badge-location-bijzonderheden">' . $bijzonderheden . '</span>';
    }
    
    $output .= '</span>';
    return $output;
  }
  
  return '';
}

/**
 * Implementation of hook_content_is_empty().
 * 
 * CCK uses this to determine if a field value is empty.
 */
function thirdwing_formatters_content_is_empty($item, $field) {
  if (empty($item['value'])) {
    return TRUE;
  }
  return FALSE;
}

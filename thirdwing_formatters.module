<?php
/**
 * @file
 * Custom field formatters for Thirdwing site - Performance Optimized
 * 
 * Provides custom CCK field formatters that were previously defined
 * through the custom_formatters module, plus Display Suite fields including
 * the node_type field with multiple formatters.
 * 
 * PERFORMANCE OPTIMIZATIONS:
 * - Reduced function call overhead
 * - Optimized conditionals (most common first)
 * - Consolidated string operations
 * - Efficient static caching
 * - Batch loading with multi-layer cache
 */

/**
 * Implementation of hook_field_formatter_info().
 */
function thirdwing_formatters_field_formatter_info() {
  return array(
    'repertoire_met_jaar' => array(
      'label' => t('Repertoire met jaar'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer_link' => array(
      'label' => t('Badge nummer (met link)'),
      'field types' => array('number_integer'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer' => array(
      'label' => t('Badge nummer (zonder link)'),
      'field types' => array('number_integer'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer_nodereference' => array(
      'label' => t('Badge nummer (node reference)'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_koorfunctie' => array(
      'label' => t('Badge koorfunctie'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_location' => array(
      'label' => t('Badge location'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_location_extended' => array(
      'label' => t('Badge location (uitgebreid)'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'datum_met_icoon' => array(
      'label' => t('Datum met icoon'),
      'field types' => array('date', 'datestamp', 'datetime'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_sleepgroep' => array(
      'label' => t('Badge sleepgroep'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_tijd' => array(
      'label' => t('Badge tijd'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_band' => array(
      'label' => t('Badge band'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'file_description_link' => array(
      'label' => t('File description link'),
      'field types' => array('filefield'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_year' => array(
      'label' => t('Badge year'),
      'field types' => array('date', 'datestamp', 'datetime'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_red' => array(
      'label' => t('Badge (rood)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_blue' => array(
      'label' => t('Badge (blauw)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_grey_light' => array(
      'label' => t('Badge (lichtgrijs)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_orange' => array(
      'label' => t('Badge (oranje)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_green' => array(
      'label' => t('Badge (groen)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_grey_dark' => array(
      'label' => t('Badge (donkergrijs)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_grey' => array(
      'label' => t('Badge (grijs)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_purple' => array(
      'label' => t('Badge (paars)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_yellow' => array(
      'label' => t('Badge (geel)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_plain' => array(
      'label' => t('Badge (zonder kleur)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_datum_en_tijd' => array(
      'label' => t('Badge datum en tijd'),
      'field types' => array('date', 'datestamp', 'datetime'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_kar' => array(
      'label' => t('Badge kar'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'node_type_icon' => array(
      'label' => t('Badge node type icon'),
      'field types' => array('nd_node_type'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'node_type' => array(
      'label' => t('Badge node type (zonder icoon)'),
      'field types' => array('nd_node_type'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'media_counts' => array(
      'label' => t('Media Counts (optimized)'),
      'field types' => array('code'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'icon_link' => array(
      'label' => t('Icon link (phone/email/mobile)'),
      'field types' => array('text', 'email'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
  );
}

/**
 * Implementation of hook_theme().
 */
function thirdwing_formatters_theme() {
  // Create theme registry with single array - more efficient than multiple entries
  $themes = array();
  
  $formatters = array(
    'repertoire_met_jaar', 'badge_nummer_link', 'badge_nummer', 'badge_nummer_nodereference',
    'badge_koorfunctie', 'badge_location', 'badge_location_extended', 'datum_met_icoon',
    'badge_sleepgroep', 'badge_tijd', 'badge_band', 'file_description_link', 'badge_year',
    'badge_red', 'badge_blue', 'badge_grey_light', 'badge_orange', 'badge_green',
    'badge_grey_dark', 'badge_grey', 'badge_purple', 'badge_yellow', 'badge_plain',
    'badge_datum_en_tijd', 'badge_kar', 'node_type_icon', 'node_type', 'media_counts',
    'icon_link'
  );
  
  foreach ($formatters as $formatter) {
    $themes['thirdwing_formatters_formatter_' . $formatter] = array(
      'arguments' => array('element' => NULL),
    );
  }
  
  $themes['thirdwing_formatters_media_counts_display'] = array(
    'arguments' => array('counts' => NULL, 'nid' => NULL),
  );
  
  // Display Suite theme functions
  $themes['thirdwing_formatters_ds_node_type_plain'] = array(
    'arguments' => array('field' => NULL),
  );
  $themes['thirdwing_formatters_ds_node_type_icon'] = array(
    'arguments' => array('field' => NULL),
  );
  $themes['thirdwing_formatters_ds_node_type_badge'] = array(
    'arguments' => array('field' => NULL),
  );
  $themes['thirdwing_formatters_ds_oefenmateriaal_default'] = array(
    'arguments' => array('field' => NULL),
  );
  $themes['thirdwing_formatters_ds_read_more_contextual_default'] = array(
    'arguments' => array('field' => NULL),
  );
  $themes['thirdwing_formatters_ds_node_count_default'] = array(
    'arguments' => array('field' => NULL),
  );
  $themes['thirdwing_formatters_ds_author_picture_default'] = array(
    'arguments' => array('field' => NULL),
  );
  $themes['thirdwing_formatters_ds_author_email_default'] = array(
    'arguments' => array('field' => NULL),
  );
  
  return $themes;
}

/**
 * Implementation of hook_nd_api().
 * 
 * Register with Node displays module.
 */
function thirdwing_formatters_nd_api() {
  return array(
    'api' => '1',
  );
}

// ============================================================================
// DISPLAY SUITE INTEGRATION
// ============================================================================

/**
 * Implementation of hook_ds_fields().
 * 
 * Create Display Suite fields with multiple formatters.
 */
function thirdwing_formatters_ds_fields($type_name, $build_mode = NULL, $extra = NULL) {
  $fields = array();
  
  // Node type field - available for all node types
  $fields['node_type'] = array(
    'title' => t('Node type'),
    'type' => DS_FIELD_TYPE_THEME,
    'status' => DS_FIELD_STATUS_STATIC,
    'properties' => array(
      'formatters' => array(
        'thirdwing_formatters_ds_node_type_plain' => t('Node type (plain text)'),
        'thirdwing_formatters_ds_node_type_icon' => t('Node type with icon'),
        'thirdwing_formatters_ds_node_type_badge' => t('Node type badge'),
      ),
    ),
  );
  
  // Read more contextual field - available for all node types
  $fields['read_more_contextual'] = array(
    'title' => t('Read More Contextual'),
    'type' => DS_FIELD_TYPE_THEME,
    'status' => DS_FIELD_STATUS_STATIC,
    'properties' => array(
      'formatters' => array(
        'thirdwing_formatters_ds_read_more_contextual_default' => t('Contextual link'),
      ),
    ),
  );
  
  // Node count field - available for all node types
  $fields['node_count'] = array(
    'title' => t('Node Count'),
    'type' => DS_FIELD_TYPE_THEME,
    'status' => DS_FIELD_STATUS_STATIC,
    'properties' => array(
      'formatters' => array(
        'thirdwing_formatters_ds_node_count_default' => t('Row number'),
      ),
    ),
  );
  
  // Author picture field - available for all node types
  $fields['author_picture'] = array(
    'title' => t('Author Picture'),
    'type' => DS_FIELD_TYPE_THEME,
    'status' => DS_FIELD_STATUS_STATIC,
    'properties' => array(
      'formatters' => array(
        'thirdwing_formatters_ds_author_picture_default' => t('User picture'),
      ),
    ),
  );
  
  // Author email field - available for all node types
  $fields['author_email'] = array(
    'title' => t('Author Email'),
    'type' => DS_FIELD_TYPE_THEME,
    'status' => DS_FIELD_STATUS_STATIC,
    'properties' => array(
      'formatters' => array(
        'thirdwing_formatters_ds_author_email_default' => t('Email link'),
      ),
    ),
  );
  
  // Oefenmateriaal field - ONLY for repertoire
  if ($type_name == 'repertoire') {
    $fields['oefenmateriaal'] = array(
      'title' => t('Oefenmateriaal'),
      'type' => DS_FIELD_TYPE_THEME,
      'status' => DS_FIELD_STATUS_STATIC,
      'properties' => array(
        'formatters' => array(
          'thirdwing_formatters_ds_oefenmateriaal_default' => t('Default (buttons)'),
        ),
      ),
    );
  }
  
  return array('nd' => $fields);
}

/**
 * Theme function: Node type plain text (Display Suite).
 * 
 * Displays node type as simple text.
 * 
 * @param array $field
 *   The field array from Display Suite containing $field['object'] with the node.
 *   
 * @return string
 *   The formatted output.
 */
function theme_thirdwing_formatters_ds_node_type_plain($field) {
  if (!isset($field['object']->type)) {
    return '';
  }
  
  return '<div class="node-type">' . check_plain($field['object']->type) . '</div>';
}

/**
 * Theme function: Node type with icon (Display Suite).
 * 
 * Displays node type with appropriate FontAwesome icon.
 * 
 * @param array $field
 *   The field array from Display Suite containing $field['object'] with the node.
 *   
 * @return string
 *   The formatted output.
 */
function theme_thirdwing_formatters_ds_node_type_icon($field) {
  if (!isset($field['object']->type)) {
    return '';
  }
  
  $node = $field['object'];
  $value = $node->type;
  
  // Map node types to FontAwesome icons
  static $icon_map = array(
    'audio' => 'microphone',
    'video' => 'film',
    'foto' => 'camera',
    'nieuws' => 'newspaper-o',
    'activiteit' => 'calendar-check-o',
    'profiel' => 'user',
    'repertoire' => 'music',
    'locatie' => 'map-marker',
  );
  
  $icon = isset($icon_map[$value]) ? $icon_map[$value] : 'file-o';
  
  return '<div class="badge badge-nodetype badge-nodetype-' . check_plain($value) . ' fa fa-' . $icon . '">' . check_plain($value) . '</div>';
}

/**
 * Theme function: Node type badge (Display Suite).
 * 
 * Displays node type as a colored badge without icon.
 * 
 * @param array $field
 *   The field array from Display Suite.
 *   
 * @return string
 *   The formatted output.
 */
function theme_thirdwing_formatters_ds_node_type_badge($field) {
  if (!isset($field['object']->type)) {
    return '';
  }
  
  $value = check_plain($field['object']->type);
  
  return '<div class="badge badge-nodetype badge-nodetype-' . $value . '">' . $value . '</div>';
}

/**
 * Theme function: Oefenmateriaal default (Display Suite).
 * 
 * Displays media count buttons for repertoire nodes.
 * OPTIMIZED: Uses preloaded counts from Views when available.
 * 
 * @param array $field
 *   The field array from Display Suite containing $field['object'] with the node.
 *   
 * @return string
 *   The formatted output.
 */
function theme_thirdwing_formatters_ds_oefenmateriaal_default($field) {
  if (!isset($field['object']->nid)) {
    return '';
  }
  
  $node = $field['object'];
  
  if (!isset($node->type) || $node->type != 'repertoire') {
    return '';
  }
  
  // PERFORMANCE OPTIMIZATION: Check if counts were already preloaded by Views
  global $thirdwing_media_counts_cache;
  if (isset($thirdwing_media_counts_cache[$node->nid])) {
    $counts = $thirdwing_media_counts_cache[$node->nid];
  }
  else {
    $counts = thirdwing_formatters_get_media_counts_for_display($node->nid);
  }
  
  // Don't display if no media
  if (empty($counts['audio']) && empty($counts['video'])) {
    return '';
  }
  
  return theme('thirdwing_formatters_media_counts_display', $counts, $node->nid);
}

/**
 * Theme function: Read More Contextual (Display Suite).
 * 
 * Displays contextual read more links based on node type and content.
 * - For activiteit: Shows "Meer info" (future) or "Lees verslag" (past)
 * - For nieuws: Shows "Lees verder" only if body is longer than teaser
 * 
 * @param array $field
 *   The field array from Display Suite containing $field['object'] with the node.
 *   
 * @return string
 *   The formatted output.
 */
function theme_thirdwing_formatters_ds_read_more_contextual_default($field) {
  if (!isset($field['object']->nid)) {
    return '';
  }
  
  $node = $field['object'];
  $output = '';
  
  // Handle activiteit nodes
  if ($node->type == 'activiteit') {
    if (isset($node->field_datum[0]['value'])) {
      $event_date = strtotime($node->field_datum[0]['value']);
      $current_date = time();
      
      if ($event_date > $current_date) {
        $link_text = 'Meer info';
      }
      else {
        $link_text = 'Lees verslag';
      }
      
      $output = l($link_text, 'node/' . $node->nid, array(
        'attributes' => array('class' => 'button fa fa-arrow-circle-right')
      ));
    }
  }
  // Handle nieuws nodes
  elseif ($node->type == 'nieuws') {
    // Check if we have body content already loaded
    if (isset($node->body) && isset($node->teaser)) {
      $body_text = strip_tags($node->body);
      $teaser_text = strip_tags($node->teaser);
      
      // If body text is longer than teaser text, there's more content to read
      if (strlen($body_text) > strlen($teaser_text)) {
        $output = l('Lees verder', 'node/' . $node->nid, array(
          'attributes' => array('class' => 'button fa fa-arrow-circle-right')
        ));
      }
    }
    else {
      // If body not loaded in teaser view, load full node
      $full_node = node_load($node->nid);
      
      if ($full_node && isset($full_node->body)) {
        $body_text = strip_tags($full_node->body);
        $teaser_text = isset($full_node->teaser) ? strip_tags($full_node->teaser) : '';
        
        if (strlen($body_text) > strlen($teaser_text)) {
          $output = l('Lees verder', 'node/' . $node->nid, array(
            'attributes' => array('class' => 'button fa fa-arrow-circle-right')
          ));
        }
      }
    }
  }
  
  return $output;
}

/**
 * Theme function: Node Count (Display Suite).
 * 
 * Returns the row number from the current view.
 * Useful for displaying numbered lists in views.
 * 
 * @param array $field
 *   The field array from Display Suite.
 *   
 * @return string
 *   The row number (1-indexed).
 */
function theme_thirdwing_formatters_ds_node_count_default($field) {
  // Get the current view
  $view = views_get_current_view();
  
  if ($view && isset($view->row_index)) {
    // The row index starts at 0, so add 1 for human-readable numbering
    return $view->row_index + 1;
  }
  
  return '';
}

/**
 * Theme function: Author Picture (Display Suite).
 * 
 * Displays the user picture of the node's author.
 * 
 * @param array $field
 *   The field array from Display Suite containing $field['object'] with the node.
 *   
 * @return string
 *   The themed user picture.
 */
function theme_thirdwing_formatters_ds_author_picture_default($field) {
  if (!isset($field['object']->uid)) {
    return '';
  }
  
  $account = user_load($field['object']->uid);
  
  if ($account) {
    return theme('user_picture', $account);
  }
  
  return '';
}

/**
 * Theme function: Author Email (Display Suite).
 * 
 * Displays the node author's email as a mailto link with envelope icon.
 * 
 * @param array $field
 *   The field array from Display Suite containing $field['object'] with the node.
 *   
 * @return string
 *   The mailto link with the author's email.
 */
function theme_thirdwing_formatters_ds_author_email_default($field) {
  if (!isset($field['object']->uid) || !isset($field['object']->nid)) {
    return '';
  }
  
  $author = user_load($field['object']->uid);
  
  if ($author && !empty($author->mail)) {
    return l(
      '<span class="fa fa-envelope-o">' . check_plain($author->mail) . '</span>',
      'mailto:' . $author->mail,
      array(
        'attributes' => array(
          'id' => 'author-email-' . $field['object']->nid,
        ),
        'html' => TRUE,
      )
    );
  }
  
  return '';
}

// ============================================================================
// CCK FIELD FORMATTERS
// ============================================================================

/**
 * Format: Repertoire met jaar
 * OPTIMIZED: Early return, direct array access
 */
function theme_thirdwing_formatters_formatter_repertoire_met_jaar($element) {
  $output = $element['#item']['safe'];
  
  // Static lookup map - faster than repeated conditionals
  static $year_fields = array(
    'field_rep_arr' => 'field_rep_arr_jaar',
    'field_rep_componist' => 'field_rep_componist_jaar',
    'field_rep_uitv' => 'field_rep_uitv_jaar',
  );
  
  $field_name = $element['#field_name'];
  
  if (isset($year_fields[$field_name]) && isset($element['#node']->{$year_fields[$field_name]}[0]['value'])) {
    $year = $element['#node']->{$year_fields[$field_name]}[0]['value'];
    if ($year) {
      $output .= ' (' . check_plain($year) . ')';
    }
  }
  
  return $output;
}

/**
 * Format: Badge nummer (met link)
 * OPTIMIZED: Consolidated string building
 */
function theme_thirdwing_formatters_formatter_badge_nummer_link($element) {
  $value = check_plain($element['#item']['value']);
  $span = '<span class="badge badge-nummer" title="Nummer">' . $value . '</span>';
  
  if (isset($element['#node']->nid)) {
    return l($span, 'node/' . $element['#node']->nid, array('html' => TRUE));
  }
  
  return $span;
}

/**
 * Format: Badge nummer (zonder link)
 */
function theme_thirdwing_formatters_formatter_badge_nummer($element) {
  return '<span class="badge badge-nummer" title="Nummer">' . check_plain($element['#item']['value']) . '</span>';
}

/**
 * Format: Badge nummer (node reference)
 * OPTIMIZED: Consolidated HTML building, static cache
 */
function theme_thirdwing_formatters_formatter_badge_nummer_nodereference($element) {
  if (empty($element['#item']['nid'])) {
    return '';
  }
  
  static $cache = array();
  $nid = $element['#item']['nid'];
  
  if (!isset($cache[$nid])) {
    $node = node_load($nid);
    if ($node && isset($node->field_audio_nummer[0]['value'], $node->field_audio_seizoen[0]['value'])) {
      $cache[$nid] = array(
        'nummer' => check_plain($node->field_audio_nummer[0]['value']),
        'seizoen' => check_plain($node->field_audio_seizoen[0]['value']),
        'url' => url('node/' . $nid),
      );
    }
    else {
      $cache[$nid] = FALSE;
    }
  }
  
  if (!$cache[$nid]) {
    return '';
  }
  
  $data = $cache[$nid];
  return '<a href="' . $data['url'] . '"><div class="badge badge-nummer">' . $data['nummer'] . 
         '</div></a><div class="badge badge-color-grey-light">' . $data['seizoen'] . '</div>';
}

/**
 * Format: Badge koorfunctie
 * OPTIMIZED: Direct array lookup instead of if/elseif chain
 */
function theme_thirdwing_formatters_formatter_badge_koorfunctie($element) {
  static $functies = array(
    'A' => 'Tenor',
    'B' => 'Bas',
    'C' => '1e Sopraan',
    'D' => '2e Sopraan',
    'E' => 'Alt',
    'Y1' => 'Dirigent',
    'Z1' => 'Toetsenist',
    'Z2' => 'Gitarist',
    'Z3' => 'Bassist',
    'Z4' => 'Drummer',
    'Z5' => 'Percussionist',
  );
  
  $value = $element['#item']['value'];
  
  if (isset($functies[$value])) {
    $label = $functies[$value];
    return '<span class="badge badge-functie badge-functie-' . $value . '" title="' . $label . '">' . $label . '</span>';
  }
  
  return '';
}

/**
 * Format: Badge location
 * OPTIMIZED: Static cache, early returns
 */
function theme_thirdwing_formatters_formatter_badge_location($element) {
  if (empty($element['#item']['nid'])) {
    return '';
  }
  
  static $cache = array();
  $nid = $element['#item']['nid'];
  
  if (!isset($cache[$nid])) {
    $node = node_load($nid);
    if ($node) {
      $cache[$nid] = array(
        'title' => check_plain($node->title),
        'plaats' => isset($node->field_l_plaats[0]['value']) ? check_plain($node->field_l_plaats[0]['value']) : '',
      );
    }
    else {
      $cache[$nid] = FALSE;
    }
  }
  
  if (!$cache[$nid]) {
    return '';
  }
  
  $data = $cache[$nid];
  return '<span class="badge badge-location fa fa-map-marker"><span class="badge-location-title">' . 
         $data['title'] . '</span> <span class="badge-location-plaats">' . $data['plaats'] . '</span></span>';
}

/**
 * Format: Badge location (uitgebreid)
 * OPTIMIZED: Reduced function calls, consolidated HTML building
 */
function theme_thirdwing_formatters_formatter_badge_location_extended($element) {
  if (empty($element['#item']['nid'])) {
    return '';
  }
  
  static $cache = array();
  $nid = $element['#item']['nid'];
  
  if (!isset($cache[$nid])) {
    $node = node_load($nid);
    if (!$node) {
      $cache[$nid] = FALSE;
    }
    else {
      $cache[$nid] = array(
        'title' => check_plain($node->title),
        'adres' => isset($node->field_l_adres[0]['value']) ? check_plain($node->field_l_adres[0]['value']) : '',
        'postcode' => isset($node->field_l_postcode[0]['value']) ? check_plain($node->field_l_postcode[0]['value']) : '',
        'plaats' => isset($node->field_l_plaats[0]['value']) ? check_plain($node->field_l_plaats[0]['value']) : '',
        'routelinks' => array(),
      );
      
      if (isset($node->field_l_routelink) && is_array($node->field_l_routelink)) {
        foreach ($node->field_l_routelink as $link) {
          if (!empty($link['url'])) {
            $url = check_url($link['url']);
            $title = !empty($link['title']) ? check_plain($link['title']) : $url;
            $cache[$nid]['routelinks'][] = '<a href="' . $url . '">' . $title . '</a>';
          }
        }
      }
    }
  }
  
  if (!$cache[$nid]) {
    return '';
  }
  
  $data = $cache[$nid];
  $output = '<span class="badge badge-location badge-location-ext fa fa-map-marker">' .
            '<span class="badge-location-title">' . $data['title'] . '</span>';
  
  if ($data['adres']) {
    $output .= '<span class="badge-location-adres">' . $data['adres'] . '</span>';
  }
  
  if ($data['plaats']) {
    $output .= '<span class="badge-location-plaats">' . $data['postcode'] . ' ' . $data['plaats'] . '</span>';
  }
  
  if (!empty($data['routelinks'])) {
    $output .= '<span class="badge-location-link">' . implode(' | ', $data['routelinks']) . '</span>';
  }
  
  // Bijzonderheden from current node
  if (isset($element['#node']->field_l_bijzonderheden[0]['value'])) {
    $bijz = $element['#node']->field_l_bijzonderheden[0]['value'];
    if ($bijz) {
      $output .= '<span class="badge-location-bijzonderheden">' . check_plain($bijz) . '</span>';
    }
  }
  
  $output .= '</span>';
  return $output;
}

/**
 * Format: Datum met icoon
 * OPTIMIZED: Direct array lookup for icons, consolidated date parsing
 */
function theme_thirdwing_formatters_formatter_datum_met_icoon($element) {
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  static $icons = array(
    'field_lidsinds' => array('icon' => 'user-plus', 'title' => 'Lid sinds'),
    'field_geboortedatum' => array('icon' => 'birthday-cake', 'title' => 'Geboortedatum'),
    'field_uitkoor' => array('icon' => 'user-times', 'title' => 'Uit het koor per'),
  );
  
  $field_name = $element['#field_name'];
  $icon_data = isset($icons[$field_name]) ? $icons[$field_name] : array('icon' => 'calendar', 'title' => 'Datum');
  
  $dt = new DateTime($element['#item']['value']);
  
  // Special case: future lidsinds = aspirant
  if ($field_name == 'field_lidsinds' && $dt > new DateTime()) {
    return '<span class="fa fa-user-plus aspirant" title="Lid sinds">Aspirant</span>';
  }
  
  return '<span class="fa fa-' . $icon_data['icon'] . '" title="' . $icon_data['title'] . '">' . 
         $dt->format('d-m-Y') . '</span>';
}

/**
 * Format: Badge sleepgroep
 * OPTIMIZED: Direct array lookup
 */
function theme_thirdwing_formatters_formatter_badge_sleepgroep($element) {
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  static $groups = array('1' => 'I', '2' => 'II', '3' => 'III', '4' => 'IV', '5' => 'V', '8' => 'OG', '9' => '-');
  
  $value = $element['#item']['value'];
  $display = isset($groups[$value]) ? $groups[$value] : $value;
  
  return '<span class="badge badge-sleepgroep" title="Sleepgroep ' . $display . '">' . $display . '</span>';
}

/**
 * Format: Badge tijd
 * OPTIMIZED: Direct comparison
 */
function theme_thirdwing_formatters_formatter_badge_tijd($element) {
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $value = check_plain($element['#item']['value']);
  $field = $element['#field_name'];
  
  if ($field == 'field_tijd_aanwezig') {
    return '<span class="badge badge-koor-tijd fa fa-users" title="Koor aanwezig">' . $value . '</span>';
  }
  elseif ($field == 'field_sleepgroep_aanwezig') {
    return '<span class="badge badge-sleepgroep-tijd fa fa-clock-o" title="Sleepgroep aanwezig">' . $value . '</span>';
  }
  
  return '<span class="badge badge-tijd fa fa-clock-o" title="Tijd">' . $value . '</span>';
}

/**
 * Format: Badge band
 * OPTIMIZED: Combined lookups, reduced conditionals
 */
function theme_thirdwing_formatters_formatter_badge_band($element) {
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  static $instruments = array(
    'field_keyboard' => array('combo' => 't', 'icon' => '&#xe00b;', 'naam' => 'toetsenist'),
    'field_gitaar' => array('combo' => 'g', 'icon' => '&#xe00a;', 'naam' => 'gitarist'),
    'field_basgitaar' => array('combo' => 'b', 'icon' => '&#xe008;', 'naam' => 'basgitarist'),
    'field_drums' => array('combo' => 'd', 'icon' => '&#xe009;', 'naam' => 'drummer'),
    'field_percussie' => array('combo' => 'p', 'icon' => '&#xe00c;', 'naam' => 'percusionist'),
  );
  
  static $statuses = array(
    '+' => array('status' => 'aanwezig', 'tekst' => 'De vaste %s is aanwezig.'),
    '?' => array('status' => 'vraag', 'tekst' => 'Het is nog niet bekend of de vaste %s aanwezig is.'),
    '-' => array('status' => 'afwezig', 'tekst' => 'De vaste %s is afwezig.'),
    'v' => array('status' => 'vervanging', 'tekst' => 'Er is vervanging voor de vaste %s aanwezig.'),
  );
  
  $field = $element['#field_name'];
  $value = $element['#item']['value'];
  
  if (!isset($instruments[$field]) || !isset($statuses[$value])) {
    return '';
  }
  
  $inst = $instruments[$field];
  $stat = $statuses[$value];
  
  return '<span class="badge badge-combo badge-combo-' . $inst['combo'] . ' badge-combo-' . $stat['status'] . 
         '" title="' . sprintf($stat['tekst'], $inst['naam']) . '">' . $inst['icon'] . '</span>';
}

/**
 * Format: File description link
 * OPTIMIZED: Combined icon mapping, reduced calls
 */
function theme_thirdwing_formatters_formatter_file_description_link($element) {
  if (empty($element['#item']['filepath'])) {
    return '';
  }
  
  static $icons = array(
    'pdf' => 'pdf', 'doc' => 'word', 'docx' => 'word', 'xls' => 'excel', 'xlsx' => 'excel',
    'ppt' => 'powerpoint', 'pptx' => 'powerpoint', 'zip' => 'archive', 'rar' => 'archive',
    'tar' => 'archive', 'gz' => 'archive', 'jpg' => 'image', 'jpeg' => 'image', 'png' => 'image',
    'gif' => 'image', 'mp3' => 'audio', 'wav' => 'audio', 'ogg' => 'audio', 'mp4' => 'video',
    'avi' => 'video', 'mov' => 'video', 'txt' => 'text', 'csv' => 'text', 'mscz' => 'audio',
    'mscx' => 'audio', 'musicxml' => 'audio', 'mid' => 'audio', 'midi' => 'audio',
  );
  
  $file = $element['#item'];
  $filepath = $file['filepath'];
  $url = file_create_url($filepath);
  $basename = basename($filepath);
  $ext = strtolower(pathinfo($filepath, PATHINFO_EXTENSION));
  
  $description = !empty($file['data']['description']) ? check_plain($file['data']['description']) : $basename;
  $icon_type = isset($icons[$ext]) ? $icons[$ext] : 'o';
  $icon_class = ($icon_type == 'o') ? 'button fa fa-file-o' : 'button fa fa-file-' . $icon_type . '-o';
  
  return l($description, $url, array(
    'attributes' => array('class' => $icon_class, 'target' => '_blank', 'title' => $basename),
    'html' => FALSE,
  ));
}

/**
 * Format: Badge year
 */
function theme_thirdwing_formatters_formatter_badge_year($element) {
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $dt = new DateTime($element['#item']['value']);
  return '<div class="badge badge-color-red">' . $dt->format('Y') . '</div>';
}

/**
 * Generic badge formatter - consolidated for all color variants
 * OPTIMIZED: Single function handles all badge colors
 */
function _thirdwing_formatters_render_badge($element, $color = '') {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  $class = $color ? 'badge badge-color-' . $color : 'badge';
  
  return '<div class="' . $class . '">' . $value . '</div>';
}

function theme_thirdwing_formatters_formatter_badge_red($element) {
  return _thirdwing_formatters_render_badge($element, 'red');
}

function theme_thirdwing_formatters_formatter_badge_blue($element) {
  return _thirdwing_formatters_render_badge($element, 'blue');
}

function theme_thirdwing_formatters_formatter_badge_grey_light($element) {
  return _thirdwing_formatters_render_badge($element, 'grey-light');
}

function theme_thirdwing_formatters_formatter_badge_orange($element) {
  return _thirdwing_formatters_render_badge($element, 'orange');
}

function theme_thirdwing_formatters_formatter_badge_green($element) {
  return _thirdwing_formatters_render_badge($element, 'green');
}

function theme_thirdwing_formatters_formatter_badge_grey_dark($element) {
  return _thirdwing_formatters_render_badge($element, 'grey-dark');
}

function theme_thirdwing_formatters_formatter_badge_grey($element) {
  return _thirdwing_formatters_render_badge($element, 'grey');
}

function theme_thirdwing_formatters_formatter_badge_purple($element) {
  return _thirdwing_formatters_render_badge($element, 'purple');
}

function theme_thirdwing_formatters_formatter_badge_yellow($element) {
  return _thirdwing_formatters_render_badge($element, 'yellow');
}

function theme_thirdwing_formatters_formatter_badge_plain($element) {
  return _thirdwing_formatters_render_badge($element, '');
}

/**
 * Format: Badge datum en tijd
 * OPTIMIZED: Pre-computed Dutch translations, consolidated string building
 */
function theme_thirdwing_formatters_formatter_badge_datum_en_tijd($element) {
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  static $days = array('Mon' => 'ma', 'Tue' => 'di', 'Wed' => 'wo', 'Thu' => 'do', 'Fri' => 'vr', 'Sat' => 'za', 'Sun' => 'zo');
  static $months = array('Jan' => 'jan', 'Feb' => 'feb', 'Mar' => 'mrt', 'Apr' => 'apr', 'May' => 'mei', 'Jun' => 'jun', 
                         'Jul' => 'jul', 'Aug' => 'aug', 'Sep' => 'sep', 'Oct' => 'okt', 'Nov' => 'nov', 'Dec' => 'dec');
  
  $dt = new DateTime($element['#item']['value']);
  $time = $dt->format('H:i');
  
  $day_en = $dt->format('D');
  $month_en = $dt->format('M');
  
  $output = '<span class="badge badge-date-wrapper">' .
            '<span class="badge badge-date fa fa-calendar" title="Datum">' .
            '<span class="badge-day-short">' . (isset($days[$day_en]) ? $days[$day_en] : $day_en) . '</span>' .
            '<span class="badge-day">' . $dt->format('d') . '</span>' .
            '<span class="badge-month">' . (isset($months[$month_en]) ? $months[$month_en] : $month_en) . '</span>' .
            '<span class="badge-year">' . $dt->format('Y') . '</span>' .
            '</span>';
  
  if ($time != '00:00') {
    $output .= '<span class="badge badge-time fa fa-clock-o" title="Begintijd">' . $time . '</span>';
  }
  
  $output .= '</span>';
  return $output;
}

/**
 * Format: Badge kar
 */
function theme_thirdwing_formatters_formatter_badge_kar($element) {
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  return '<span class="badge badge-kar fa fa-truck" title="Karrijder">' . check_plain($element['#item']['value']) . '</span>';
}

/**
 * Format: Badge node type icon
 * Displays node type with appropriate FontAwesome icon
 */
function theme_thirdwing_formatters_formatter_node_type_icon($element) {
  if (!isset($element['#node']->type)) {
    return '';
  }
  
  $node = $element['#node'];
  $value = $node->type;
  
  // Map node types to FontAwesome icons
  static $icon_map = array(
    'audio' => 'microphone',
    'video' => 'film',
    'foto' => 'camera',
    'nieuws' => 'newspaper-o',
    'activiteit' => 'calendar-check-o',
    'profiel' => 'user',
    'repertoire' => 'music',
  );
  
  $icon = isset($icon_map[$value]) ? $icon_map[$value] : 'file-o';
  
  return '<div class="badge badge-nodetype badge-nodetype-' . check_plain($value) . ' fa fa-' . $icon . '">' . check_plain($value) . '</div>';
}

/**
 * Format: Badge node type (without icon)
 * Displays node type without FontAwesome icon
 */
function theme_thirdwing_formatters_formatter_node_type($element) {
  if (!isset($element['#node']->type)) {
    return '';
  }
  
  $value = check_plain($element['#node']->type);
  
  return '<div class="badge badge-nodetype badge-nodetype-' . $value . '">' . $value . '</div>';
}

/**
 * Format: Icon link (phone/email/mobile)
 * Displays value with appropriate icon and link based on field name
 * OPTIMIZED: Direct array lookup for field icons
 */
function theme_thirdwing_formatters_formatter_icon_link($element) {
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  static $field_config = array(
    'field_mobiel' => array('icon' => 'mobile', 'prefix' => 'tel:'),
    'field_telefoon' => array('icon' => 'phone', 'prefix' => 'tel:'),
    'field_email' => array('icon' => 'envelope-o', 'prefix' => 'mailto:'),
  );
  
  $field_name = $element['#field_name'];
  $value = $element['#item']['value'];
  
  // Check if this field has icon configuration
  if (isset($field_config[$field_name])) {
    $config = $field_config[$field_name];
    $icon = $config['icon'];
    $prefix = $config['prefix'];
    
    // Generate unique ID if node is available
    $id = isset($element['#node']->nid) ? $field_name . '-' . $element['#node']->nid : '';
    
    return l(
      '<span class="fa fa-' . $icon . '">' . check_plain($value) . '</span>',
      $prefix . $value,
      array(
        'attributes' => array(
          'id' => $id,
        ),
        'html' => TRUE,
      )
    );
  }
  
  // Fallback for fields without specific config
  return check_plain($value);
}

/**
 * Format: Media counts
 */
function theme_thirdwing_formatters_formatter_media_counts($element) {
  if (!isset($element['#node']->nid) || $element['#node']->type != 'repertoire') {
    return '';
  }
  
  $counts = thirdwing_formatters_get_media_counts_for_display($element['#node']->nid);
  return theme('thirdwing_formatters_media_counts_display', $counts, $element['#node']->nid);
}

/**
 * Implementation of hook_content_is_empty().
 */
function thirdwing_formatters_content_is_empty($item, $field) {
  return empty($item['value']);
}

// ============================================================================
// MEDIA COUNTS: Optimized Performance
// ============================================================================

/**
 * Implementation of hook_nodeapi()
 * OPTIMIZED: Direct cache clearing
 */
function thirdwing_formatters_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  if (($op == 'insert' || $op == 'update' || $op == 'delete') && 
      in_array($node->type, array('audio', 'video')) && 
      isset($node->field_repertoire[0]['nid'])) {
    
    cache_clear_all('repertoire_media_counts_' . $node->field_repertoire[0]['nid'], 'cache');
  }
}

/**
 * Theme: Media counts display
 * OPTIMIZED: Early return, consolidated link building
 */
function theme_thirdwing_formatters_media_counts_display($counts, $nid) {
  if (empty($counts['audio']) && empty($counts['video'])) {
    return '';
  }
  
  $output = '<div class="media-counts-wrapper">';
  
  if ($counts['audio'] > 0) {
    $output .= l($counts['audio'] . ' Audio opnamen', 'node/' . $nid, 
                 array('attributes' => array('class' => 'button fa fa-file-audio-o'), 'fragment' => 'audio'));
  }
  
  if ($counts['video'] > 0) {
    $output .= l($counts['video'] . ' Video opnamen', 'node/' . $nid, 
                 array('attributes' => array('class' => 'button fa fa-file-video-o'), 'fragment' => 'video'));
  }
  
  return $output . '</div>';
}

/**
 * Get media counts with triple-layer caching
 * OPTIMIZED: Streamlined cache checks
 */
function thirdwing_formatters_get_media_counts_for_display($nid) {
  static $static_cache = array();
  
  // Layer 1: Static cache
  if (isset($static_cache[$nid])) {
    return $static_cache[$nid];
  }
  
  // Layer 2: Global Views cache
  global $thirdwing_media_counts_cache;
  if (isset($thirdwing_media_counts_cache[$nid])) {
    $static_cache[$nid] = $thirdwing_media_counts_cache[$nid];
    return $thirdwing_media_counts_cache[$nid];
  }
  
  // Layer 3: Drupal persistent cache
  $cache_key = 'repertoire_media_counts_' . $nid;
  $cached = cache_get($cache_key, 'cache');
  
  if ($cached && !empty($cached->data)) {
    $static_cache[$nid] = $cached->data;
    return $cached->data;
  }
  
  // Layer 4: Database query
  $counts = _thirdwing_formatters_get_media_counts($nid);
  
  cache_set($cache_key, $counts, 'cache', time() + 3600);
  $static_cache[$nid] = $counts;
  
  return $counts;
}

/**
 * Query database for media counts
 * OPTIMIZED: Single query with minimal processing
 */
function _thirdwing_formatters_get_media_counts($nid) {
  $result = db_query("
    SELECT n.type, COUNT(DISTINCT n.nid) as count
    FROM {node} n
    INNER JOIN {content_field_repertoire} cr ON n.nid = cr.nid
    INNER JOIN {term_node} tn ON n.nid = tn.nid
    WHERE cr.field_repertoire_nid = %d
      AND n.status = 1
      AND n.type IN ('audio', 'video')
      AND tn.tid = 28
    GROUP BY n.type
  ", $nid);
  
  $counts = array('audio' => 0, 'video' => 0);
  
  while ($row = db_fetch_object($result)) {
    $counts[$row->type] = (int)$row->count;
  }
  
  return $counts;
}

/**
 * Implementation of hook_views_pre_render()
 * OPTIMIZED: Batch loading with single query
 */
function thirdwing_formatters_views_pre_render(&$view) {
  if (empty($view->result)) {
    return;
  }
  
  $nids = array();
  
  foreach ($view->result as $result) {
    $type = isset($result->node_type) ? $result->node_type : (isset($result->type) ? $result->type : NULL);
    
    if ($type == 'repertoire' && isset($result->nid)) {
      $nids[] = (int)$result->nid;
    }
  }
  
  if (!empty($nids)) {
    $all_counts = thirdwing_formatters_preload_media_counts($nids);
    
    global $thirdwing_media_counts_cache;
    if (!isset($thirdwing_media_counts_cache)) {
      $thirdwing_media_counts_cache = array();
    }
    $thirdwing_media_counts_cache = array_merge($thirdwing_media_counts_cache, $all_counts);
  }
}

/**
 * Batch preload media counts
 * OPTIMIZED: Single query for all nodes
 */
function thirdwing_formatters_preload_media_counts($nids) {
  if (empty($nids)) {
    return array();
  }
  
  $placeholders = db_placeholders($nids);
  $args = array_merge($nids, array(28));
  
  $result = db_query("
    SELECT cr.field_repertoire_nid as repertoire_nid, 
           n.type, 
           COUNT(DISTINCT n.nid) as count
    FROM {node} n
    INNER JOIN {content_field_repertoire} cr ON n.nid = cr.nid
    INNER JOIN {term_node} tn ON n.nid = tn.nid
    WHERE cr.field_repertoire_nid IN (" . $placeholders . ")
      AND n.status = 1
      AND n.type IN ('audio', 'video')
      AND tn.tid = %d
    GROUP BY cr.field_repertoire_nid, n.type
  ", $args);
  
  $counts = array();
  while ($row = db_fetch_object($result)) {
    if (!isset($counts[$row->repertoire_nid])) {
      $counts[$row->repertoire_nid] = array('audio' => 0, 'video' => 0);
    }
    $counts[$row->repertoire_nid][$row->type] = (int)$row->count;
  }
  
  // Fill zeros for nodes without media
  foreach ($nids as $nid) {
    if (!isset($counts[$nid])) {
      $counts[$nid] = array('audio' => 0, 'video' => 0);
    }
  }
  
  return $counts;
}

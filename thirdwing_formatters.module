<?php
/**
 * @file
 * Custom field formatters for Thirdwing site
 * 
 * Provides custom CCK field formatters that were previously defined
 * through the custom_formatters module.
 */

/**
 * Implementation of hook_field_formatter_info().
 * 
 * Register custom formatters with CCK.
 */
function thirdwing_formatters_field_formatter_info() {
  return array(
    'repertoire_met_jaar' => array(
      'label' => t('Repertoire met jaar'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer_link' => array(
      'label' => t('Badge nummer (met link)'),
      'field types' => array('number_integer'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer' => array(
      'label' => t('Badge nummer (zonder link)'),
      'field types' => array('number_integer'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_nummer_nodereference' => array(
      'label' => t('Badge nummer (node reference)'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_koorfunctie' => array(
      'label' => t('Badge koorfunctie'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_location' => array(
      'label' => t('Badge location'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_location_extended' => array(
      'label' => t('Badge location (uitgebreid)'),
      'field types' => array('nodereference'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'datum_met_icoon' => array(
      'label' => t('Datum met icoon'),
      'field types' => array('date', 'datestamp', 'datetime'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_sleepgroep' => array(
      'label' => t('Badge sleepgroep'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_tijd' => array(
      'label' => t('Badge tijd'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_band' => array(
      'label' => t('Badge band'),
      'field types' => array('text'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'file_description_link' => array(
      'label' => t('File description link'),
      'field types' => array('filefield'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_year' => array(
      'label' => t('Badge year'),
      'field types' => array('date', 'datestamp', 'datetime'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_red' => array(
      'label' => t('Badge (rood)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_blue' => array(
      'label' => t('Badge (blauw)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_grey_light' => array(
      'label' => t('Badge (lichtgrijs)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_orange' => array(
      'label' => t('Badge (oranje)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_green' => array(
      'label' => t('Badge (groen)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_grey_dark' => array(
      'label' => t('Badge (donkergrijs)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_grey' => array(
      'label' => t('Badge (grijs)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_purple' => array(
      'label' => t('Badge (paars)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_yellow' => array(
      'label' => t('Badge (geel)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_plain' => array(
      'label' => t('Badge (zonder kleur)'),
      'field types' => array('text', 'number_integer', 'number_decimal', 'number_float'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
    'badge_datum_en_tijd' => array(
      'label' => t('Badge datum en tijd'),
      'field types' => array('date', 'datestamp', 'datetime'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
  );
}

/**
 * Implementation of hook_theme().
 * 
 * Register theme functions for formatters.
 */
function thirdwing_formatters_theme() {
  return array(
    'thirdwing_formatters_formatter_repertoire_met_jaar' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer_link' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_nummer_nodereference' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_koorfunctie' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_location' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_location_extended' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_datum_met_icoon' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_sleepgroep' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_tijd' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_band' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_file_description_link' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_year' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_red' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_blue' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_grey_light' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_orange' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_green' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_grey_dark' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_grey' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_purple' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_yellow' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_plain' => array(
      'arguments' => array('element' => NULL),
    ),
    'thirdwing_formatters_formatter_badge_datum_en_tijd' => array(
      'arguments' => array('element' => NULL),
    ),
  );
}

/**
 * Format a repertoire field with corresponding year field appended in parentheses.
 * 
 * Automatically detects the correct year field based on the current field name:
 * - field_rep_arr -> field_rep_arr_jaar
 * - field_rep_componist -> field_rep_componist_jaar
 * - field_rep_uitv -> field_rep_uitv_jaar
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_repertoire_met_jaar($element) {
  // Check if field is empty
  if (empty($element['#item']['safe'])) {
    return '';
  }
  
  $output = $element['#item']['safe'];
  
  // Map field names to their corresponding year fields
  $year_field_map = array(
    'field_rep_arr' => 'field_rep_arr_jaar',
    'field_rep_componist' => 'field_rep_componist_jaar',
    'field_rep_uitv' => 'field_rep_uitv_jaar',
  );
  
  // Get the current field name
  $field_name = $element['#field_name'];
  
  // Check if we have a year field mapping for this field
  if (isset($year_field_map[$field_name])) {
    $year_field = $year_field_map[$field_name];
    
    // Append the year if it exists
    if (isset($element['#node']->{$year_field}[0]['value']) && !empty($element['#node']->{$year_field}[0]['value'])) {
      $output .= ' (' . check_plain($element['#node']->{$year_field}[0]['value']) . ')';
    }
  }
  
  return $output;
}

/**
 * Format an integer field as a badge with link to the node.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer_link($element) {
  // Check if field is empty
  if (!isset($element['#item']['value']) || $element['#item']['value'] === '') {
    return '';
  }
  
  $value = $element['#item']['value'];
  
  // Get the node path
  if (isset($element['#node']->nid)) {
    $node_path = 'node/' . $element['#node']->nid;
    
    return l('<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>', $node_path, array('html' => TRUE));
  }
  
  // Fallback if no node context
  return '<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>';
}

/**
 * Format an integer field as a badge without link.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer($element) {
  // Check if field is empty
  if (!isset($element['#item']['value']) || $element['#item']['value'] === '') {
    return '';
  }
  
  $value = $element['#item']['value'];
  
  return '<span class="badge badge-nummer" title="Nummer">' . check_plain($value) . '</span>';
}

/**
 * Format a node reference field as badge nummer with seizoen.
 * 
 * Displays the field_audio_nummer and field_audio_seizoen from the referenced node.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_nummer_nodereference($element) {
  if (!empty($element['#item']['nid'])) {
    $nid = $element['#item']['nid'];
    
    // Use static cache to avoid loading the same node multiple times
    static $node_cache = array();
    if (!isset($node_cache[$nid])) {
      $node_cache[$nid] = node_load($nid);
    }
    $referenced_node = $node_cache[$nid];
    
    if ($referenced_node && isset($referenced_node->field_audio_nummer[0]['value']) && isset($referenced_node->field_audio_seizoen[0]['value'])) {
      $audio_nummer = $referenced_node->field_audio_nummer[0]['value'];
      $audio_type = check_plain($referenced_node->field_audio_seizoen[0]['value']);
      $node_url = url('node/' . $referenced_node->nid);
      
      return '<a href="' . $node_url . '"><div class="badge badge-nummer">' . check_plain($audio_nummer) . '</div></a><div class="badge badge-color-grey-light">' . $audio_type . '</div>';
    }
  }
  
  return '';
}

/**
 * Format a text field as a choir function badge.
 * 
 * Converts function codes to full names and displays them as badges.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_koorfunctie($element) {
  // Check if field is empty
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $value = $element['#item']['value'];
  $key = '';
  
  // Map function codes to labels
  if ($value == 'A') { 
    $key = 'Tenor'; 
  }
  elseif ($value == 'B') { 
    $key = 'Bas'; 
  }
  elseif ($value == 'C') { 
    $key = '1e Sopraan'; 
  }
  elseif ($value == 'D') { 
    $key = '2e Sopraan'; 
  }
  elseif ($value == 'E') { 
    $key = 'Alt'; 
  }
  elseif ($value == 'Y1') { 
    $key = 'Dirigent'; 
  }
  elseif ($value == 'Z1') { 
    $key = 'Toetsenist'; 
  }
  elseif ($value == 'Z2') { 
    $key = 'Gitarist'; 
  }
  elseif ($value == 'Z3') { 
    $key = 'Bassist'; 
  }
  elseif ($value == 'Z4') { 
    $key = 'Drummer'; 
  }
  elseif ($value == 'Z5') { 
    $key = 'Percussionist'; 
  }
  
  if ($key) {
    return '<span class="badge badge-functie badge-functie-' . check_plain($value) . '" title="' . check_plain($key) . '">' . check_plain($key) . '</span>';
  }
  
  return '';
}

/**
 * Format a node reference as a location badge (basic).
 * 
 * Displays location title and plaats from the referenced node.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_location($element) {
  $nid = $element['#item']['nid'];
  
  if ($nid) {
    // Use static cache to avoid loading the same node multiple times
    static $node_cache = array();
    if (!isset($node_cache[$nid])) {
      $node_cache[$nid] = node_load($nid);
    }
    $node = $node_cache[$nid];
    
    if ($node) {
      $title = check_plain($node->title);
      $field_value = '';
      
      if (isset($node->field_l_plaats) && !empty($node->field_l_plaats[0]['value'])) {
        $field_value = check_plain($node->field_l_plaats[0]['value']);
      }
      
      return '<span class="badge badge-location fa fa-map-marker"><span class="badge-location-title">' . $title . '</span> <span class="badge-location-plaats">' . $field_value . '</span></span>';
    }
  }
  
  return '';
}

/**
 * Format a node reference as a location badge (extended).
 * 
 * Displays full location details including address, postcode, plaats, route links, and notes.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_location_extended($element) {
  $nid = $element['#item']['nid'];
  
  if ($nid) {
    // Use static cache to avoid loading the same node multiple times
    static $node_cache = array();
    if (!isset($node_cache[$nid])) {
      $node_cache[$nid] = node_load($nid);
    }
    $node = $node_cache[$nid];
    
    if ($node) {
      $title = check_plain($node->title);
      $output = '<span class="badge badge-location badge-location-ext fa fa-map-marker"><span class="badge-location-title">' . $title . '</span>';
      
      // Get field_l_adres
      if (isset($node->field_l_adres) && !empty($node->field_l_adres[0]['value'])) {
        $adres = check_plain($node->field_l_adres[0]['value']);
        $output .= '<span class="badge-location-adres">' . $adres . '</span>';
      }
      
      // Get field_l_postcode and field_l_plaats
      $postcode = '';
      if (isset($node->field_l_postcode) && !empty($node->field_l_postcode[0]['value'])) {
        $postcode = check_plain($node->field_l_postcode[0]['value']);
      }
      
      if (isset($node->field_l_plaats) && !empty($node->field_l_plaats[0]['value'])) {
        $plaats = check_plain($node->field_l_plaats[0]['value']);
        $output .= '<span class="badge-location-plaats">' . $postcode . ' ' . $plaats . '</span>';
      }
      
      // Get field_l_routelink (link field with multiple values)
      $routelinks = array();
      if (isset($node->field_l_routelink) && is_array($node->field_l_routelink)) {
        foreach ($node->field_l_routelink as $link_item) {
          if (!empty($link_item['url'])) {
            $link_url = check_url($link_item['url']);
            $link_title = !empty($link_item['title']) ? check_plain($link_item['title']) : $link_url;
            $routelinks[] = '<a href="' . $link_url . '">' . $link_title . '</a>';
          }
        }
        if (!empty($routelinks)) {
          $output .= '<span class="badge-location-link">' . implode(' | ', $routelinks) . '</span>';
        }
      }
      
      // Get field_l_bijzonderheden from the current node (not the referenced node)
      $current_node = $element['#node'];
      if (isset($current_node->field_l_bijzonderheden) && !empty($current_node->field_l_bijzonderheden[0]['value'])) {
        $bijzonderheden = check_plain($current_node->field_l_bijzonderheden[0]['value']);
        $output .= '<span class="badge-location-bijzonderheden">' . $bijzonderheden . '</span>';
      }
      
      $output .= '</span>';
      return $output;
    }
  }
  
  return '';
}

/**
 * Format a date field with contextual icon.
 * 
 * Displays different icons based on the field name:
 * - field_lidsinds: user-plus icon, shows "Aspirant" if date is in the future
 * - field_geboortedatum: birthday-cake icon
 * - field_uitkoor: user-times icon
 * - default: calendar icon
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_datum_met_icoon($element) {
  // Check if field is empty
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $date = $element['#item']['value'];
  $field_name = $element['#field_name'];
  
  // Determine icon and title based on field name
  if ($field_name == 'field_lidsinds') {
    $icon = 'user-plus';
    $title = 'Lid sinds';
  }
  elseif ($field_name == 'field_geboortedatum') {
    $icon = 'birthday-cake';
    $title = 'Geboortedatum';
  }
  elseif ($field_name == 'field_uitkoor') {
    $icon = 'user-times';
    $title = 'Uit het koor per';
  }
  else {
    $icon = 'calendar';
    $title = 'Datum';
  }
  
  // Parse the date
  $dt = new DateTime($date);
  $now = new DateTime();
  
  // Special handling for field_lidsinds in the future
  if ($dt > $now && $field_name == 'field_lidsinds') {
    return '<span class="fa fa-' . $icon . ' aspirant" title="' . check_plain($title) . '">Aspirant</span>';
  }
  else {
    // Format the date as dd-mm-yyyy
    $formatted_date = $dt->format('d-m-Y');
    return '<span class="fa fa-' . $icon . '" title="' . check_plain($title) . '">' . $formatted_date . '</span>';
  }
}

/**
 * Format a text field as a sleepgroep badge.
 * 
 * Converts numeric values to Roman numerals and special codes.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_sleepgroep($element) {
  // Check if field is empty
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $value = $element['#item']['value'];
  
  // Convert values to display format
  if ($value == 1) { 
    $value = 'I'; 
  }
  elseif ($value == 2) { 
    $value = 'II'; 
  }
  elseif ($value == 3) { 
    $value = 'III'; 
  }
  elseif ($value == 4) { 
    $value = 'IV'; 
  }
  elseif ($value == 5) { 
    $value = 'V'; 
  }
  elseif ($value == 8) { 
    $value = 'OG'; 
  }
  elseif ($value == 9) { 
    $value = '-'; 
  }
  
  return '<span class="badge badge-sleepgroep" title="Sleepgroep ' . check_plain($value) . '">' . check_plain($value) . '</span>';
}

/**
 * Format a text field as a tijd badge with contextual styling.
 * 
 * Shows different icons and classes based on the field name:
 * - field_tijd_aanwezig: users icon with "Koor aanwezig" title
 * - field_sleepgroep_aanwezig: users icon with "Koor aanwezig" title
 * - other fields: clock icon with "Tijd" title
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_tijd($element) {
  // Check if field is empty
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $value = check_plain($element['#item']['value']);
  $field_name = $element['#field_name'];
  
  // Determine styling based on field name
  if ($field_name == 'field_tijd_aanwezig') {
    return '<span class="badge badge-koor-tijd fa fa-users" title="Koor aanwezig">' . $value . '</span>';
  }
  elseif ($field_name == 'field_sleepgroep_aanwezig') {
    return '<span class="badge badge-sleepgroep-tijd fa fa-clock-o" title="Sleepgroep aanwezig">' . $value . '</span>';
  }
  else {
    return '<span class="badge badge-tijd fa fa-clock-o" title="Tijd">' . $value . '</span>';
  }
}

/**
 * Format a text field as a band member badge.
 * 
 * Shows band instrument icons with status indicators based on field name and value.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_band($element) {
  // Check if field is empty
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $value = $element['#item']['value'];
  $fieldname = $element['#field_name'];
  
  // Determine instrument type based on field name
  if ($fieldname == 'field_keyboard') { 
    $combo = 't'; 
    $icon = '&#xe00b;'; 
    $naam = 'toetsenist'; 
  }
  elseif ($fieldname == 'field_gitaar') { 
    $combo = 'g'; 
    $icon = '&#xe00a;'; 
    $naam = 'gitarist'; 
  }
  elseif ($fieldname == 'field_basgitaar') { 
    $combo = 'b'; 
    $icon = '&#xe008;'; 
    $naam = 'basgitarist'; 
  }
  elseif ($fieldname == 'field_drums') { 
    $combo = 'd'; 
    $icon = '&#xe009;'; 
    $naam = 'drummer'; 
  }
  elseif ($fieldname == 'field_percussie') { 
    $combo = 'p'; 
    $icon = '&#xe00c;'; 
    $naam = 'percusionist'; 
  }
  else {
    return '';
  }
  
  // Determine status based on value
  if ($value == '+') { 
    $status = 'aanwezig'; 
    $uitleg = 'De vaste ' . $naam . ' is aanwezig.';
  }
  elseif ($value == '?') { 
    $status = 'vraag'; 
    $uitleg = 'Het is nog niet bekend of de vaste ' . $naam . ' aanwezig is.';
  }
  elseif ($value == '-') { 
    $status = 'afwezig'; 
    $uitleg = 'De vaste ' . $naam . ' is afwezig.'; 
  }
  elseif ($value == 'v') { 
    $status = 'vervanging'; 
    $uitleg = 'Er is vervanging voor de vaste ' . $naam . ' aanwezig.'; 
  }
  else {
    return '';
  }
  
  return '<span class="badge badge-combo badge-combo-' . $combo . ' badge-combo-' . $status . '" title="' . check_plain($uitleg) . '">' . $icon . '</span>';
}

/**
 * Format a file field displaying the description as a link with file icon.
 * 
 * Shows file description (or filename if no description) as a button link with
 * FontAwesome icon based on file extension.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_file_description_link($element) {
  // Check if field is empty
  if (empty($element['#item']['filepath'])) {
    return '';
  }
  
  $file = $element['#item'];
  $filepath = $file['filepath'];
  $url = file_create_url($filepath);
  
  // Get description or fallback to filename
  $description = !empty($file['data']['description']) ? check_plain($file['data']['description']) : basename($filepath);
  
  // Get filename for title attribute
  $filename = basename($filepath);
  
  // Get file extension
  $extension = strtolower(pathinfo($filepath, PATHINFO_EXTENSION));
  
  // Map common extensions to FontAwesome file icons
  $icon_map = array(
    'pdf' => 'pdf',
    'doc' => 'word',
    'docx' => 'word',
    'xls' => 'excel',
    'xlsx' => 'excel',
    'ppt' => 'powerpoint',
    'pptx' => 'powerpoint',
    'zip' => 'archive',
    'rar' => 'archive',
    'tar' => 'archive',
    'gz' => 'archive',
    'jpg' => 'image',
    'jpeg' => 'image',
    'png' => 'image',
    'gif' => 'image',
    'mp3' => 'audio',
    'wav' => 'audio',
    'ogg' => 'audio',
    'mp4' => 'video',
    'avi' => 'video',
    'mov' => 'video',
    'txt' => 'text',
    'csv' => 'text',
    'mscz' => 'audio',
    'mscx' => 'audio',
    'musicxml' => 'audio',
    'mid' => 'audio',
    'midi' => 'audio',
  );
  
  // Determine icon class - for unknown types, just use 'o' which will become 'file-o'
  $icon_type = isset($icon_map[$extension]) ? $icon_map[$extension] : 'o';
  
  // Build the full icon class
  $icon_class = ($icon_type == 'o') ? 'button fa fa-file-o' : 'button fa fa-file-' . $icon_type . '-o';
  
  return l($description, $url, array(
    'attributes' => array(
      'class' => $icon_class,
      'target' => '_blank',
      'title' => check_plain($filename),
    ),
    'html' => FALSE,
  ));
}

/**
 * Format a date field as a year badge.
 * 
 * Displays only the year from a date field in a red badge.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_year($element) {
  // Check if field is empty
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $date = $element['#item']['value'];
  $dt = new DateTime($date);
  
  // Format as year only
  $year = $dt->format('Y');
  
  return '<div class="badge badge-color-red">' . $year . '</div>';
}

/**
 * Format a field as a red badge.
 */
function theme_thirdwing_formatters_formatter_badge_red($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-red">' . $value . '</div>';
}

/**
 * Format a field as a blue badge.
 */
function theme_thirdwing_formatters_formatter_badge_blue($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-blue">' . $value . '</div>';
}

/**
 * Format a field as a light grey badge.
 */
function theme_thirdwing_formatters_formatter_badge_grey_light($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-grey-light">' . $value . '</div>';
}

/**
 * Format a field as an orange badge.
 */
function theme_thirdwing_formatters_formatter_badge_orange($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-orange">' . $value . '</div>';
}

/**
 * Format a field as a green badge.
 */
function theme_thirdwing_formatters_formatter_badge_green($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-green">' . $value . '</div>';
}

/**
 * Format a field as a dark grey badge.
 */
function theme_thirdwing_formatters_formatter_badge_grey_dark($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-grey-dark">' . $value . '</div>';
}

/**
 * Format a field as a grey badge.
 */
function theme_thirdwing_formatters_formatter_badge_grey($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-grey">' . $value . '</div>';
}

/**
 * Format a field as a purple badge.
 */
function theme_thirdwing_formatters_formatter_badge_purple($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-purple">' . $value . '</div>';
}

/**
 * Format a field as a yellow badge.
 */
function theme_thirdwing_formatters_formatter_badge_yellow($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge badge-color-yellow">' . $value . '</div>';
}

/**
 * Format a field as a plain badge (no color).
 */
function theme_thirdwing_formatters_formatter_badge_plain($element) {
  if (empty($element['#item']['value']) && $element['#item']['value'] !== '0') {
    return '';
  }
  $value = isset($element['#item']['safe']) ? $element['#item']['safe'] : check_plain($element['#item']['value']);
  return '<div class="badge">' . $value . '</div>';
}

/**
 * Format a date field as a date and time badge.
 * 
 * Displays date with day, month, year and optionally time if not 00:00.
 * 
 * @param $element
 *   The field element to format.
 * @return
 *   The formatted output.
 */
function theme_thirdwing_formatters_formatter_badge_datum_en_tijd($element) {
  // Check if field is empty
  if (empty($element['#item']['value'])) {
    return '';
  }
  
  $date = $element['#item']['value'];
  $dt = new DateTime($date);
  
  // Dutch day names (short)
  $dutch_days = array(
    'Mon' => 'ma',
    'Tue' => 'di',
    'Wed' => 'wo',
    'Thu' => 'do',
    'Fri' => 'vr',
    'Sat' => 'za',
    'Sun' => 'zo',
  );
  
  // Dutch month names (short)
  $dutch_months = array(
    'Jan' => 'jan',
    'Feb' => 'feb',
    'Mar' => 'mrt',
    'Apr' => 'apr',
    'May' => 'mei',
    'Jun' => 'jun',
    'Jul' => 'jul',
    'Aug' => 'aug',
    'Sep' => 'sep',
    'Oct' => 'okt',
    'Nov' => 'nov',
    'Dec' => 'dec',
  );
  
  // Format date parts
  $day_short_en = $dt->format('D'); // English short day
  $month_en = $dt->format('M'); // English short month
  
  $day_short = isset($dutch_days[$day_short_en]) ? $dutch_days[$day_short_en] : $day_short_en;
  $day = $dt->format('d'); // Day number (01-31)
  $month = isset($dutch_months[$month_en]) ? $dutch_months[$month_en] : $month_en;
  $year = $dt->format('Y'); // Year (2024)
  $time = $dt->format('H:i'); // Time (14:30)
  
  // Build output
  $output = '<span class="badge badge-date-wrapper">';
  $output .= '<span class="badge badge-date fa fa-calendar" title="Datum">';
  $output .= '<span class="badge-day-short">' . $day_short . '</span>';
  $output .= '<span class="badge-day">' . $day . '</span>';
  $output .= '<span class="badge-month">' . $month . '</span>';
  $output .= '<span class="badge-year">' . $year . '</span>';
  $output .= '</span>';
  
  // Add time badge only if not midnight
  if ($time != '00:00') {
    $output .= '<span class="badge badge-time fa fa-clock-o" title="Begintijd">' . $time . '</span>';
  }
  
  $output .= '</span>';
  
  return $output;
}

/**
 * Implementation of hook_content_is_empty().
 * 
 * CCK uses this to determine if a field value is empty.
 */
function thirdwing_formatters_content_is_empty($item, $field) {
  if (empty($item['value'])) {
    return TRUE;
  }
  return FALSE;
}
